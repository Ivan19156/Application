<ng-container *ngIf="vm$ | async as vm">
  <div class="form-container">
    <mat-card class="form-card">
      <mat-card-header>
        <button mat-icon-button class="back-button" routerLink="/events">
          <mat-icon>arrow_back</mat-icon>
        </button>
        <div>
          <mat-card-title>Create New Event</mat-card-title>
          <mat-card-subtitle>Fill in the details to create an amazing event</mat-card-subtitle>
        </div>
      </mat-card-header>
      <mat-card-content>
        <form [formGroup]="eventForm" (ngSubmit)="onSubmit()">
          
          <!-- Event Title -->
          <mat-form-field appearance="outline">
            <mat-label>Event Title</mat-label>
            <input matInput formControlName="title" placeholder="e.g., Tech Conference 2025">
            <mat-error *ngIf="hasError('title', 'required')">Title is required.</mat-error>
            <mat-error *ngIf="hasError('title', 'minlength')">Title is too short.</mat-error>
          </mat-form-field>

          <!-- Description -->
          <mat-form-field appearance="outline">
            <mat-label>Description</mat-label>
            <textarea matInput formControlName="description" placeholder="Describe what makes your event special..." rows="4"></textarea>
          </mat-form-field>

          <!-- Date and Time Row -->
          <div class="date-time-row">
            <mat-form-field appearance="outline">
              <mat-label>Date</mat-label>
              <input matInput [matDatepicker]="picker" formControlName="date" [min]="minDate" readonly>
              <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
              <mat-datepicker #picker></mat-datepicker>
              <mat-error *ngIf="hasError('date', 'required')">Date is required.</mat-error>
            </mat-form-field>
            <mat-form-field appearance="outline">
              <mat-label>Time</mat-label>
              <input matInput [ngxTimepicker]="timePicker" formControlName="time" readonly>
              <mat-icon matIconSuffix (click)="timePicker.open()">watch_later</mat-icon>
              <mat-error *ngIf="hasError('time', 'required')">Time is required.</mat-error>
            </mat-form-field>
            <ngx-material-timepicker #timePicker [format]="24"></ngx-material-timepicker>
          </div>
          <mat-error *ngIf="formHasDateError" class="form-level-error">
            Event date and time cannot be in the past.
          </mat-error>

          <!-- Location -->
          <mat-form-field appearance="outline">
            <mat-label>Location</mat-label>
            <input matInput formControlName="location" placeholder="e.g., Convention Center, San Francisco">
            <mat-error *ngIf="hasError('location', 'required')">Location is required.</mat-error>
          </mat-form-field>

          <!-- Tags Input -->
          <mat-form-field class="chip-list-field" appearance="outline">
            <mat-label>Tags (up to 5)</mat-label>
            <mat-chip-grid #chipGrid aria-label="Enter tags">
              <mat-chip-row *ngFor="let tag of tags" (removed)="removeTag(tag)">
                {{tag}}
                <button matChipRemove [attr.aria-label]="'remove ' + tag">
                  <mat-icon>cancel</mat-icon>
                </button>
              </mat-chip-row>
            </mat-chip-grid>
            <input placeholder="New tag..."
                   #tagInput
                   [formControl]="tagCtrl"
                   [matChipInputFor]="chipGrid"
                   [matAutocomplete]="auto"
                   [matChipInputSeparatorKeyCodes]="[13, 188]" 
                   (matChipInputTokenEnd)="addTag($event)"/>
            <mat-autocomplete #auto="matAutocomplete" (optionSelected)="selectedTag($event)">
              <mat-option *ngFor="let tag of filteredTags | async" [value]="tag">
                {{tag}}
              </mat-option>
            </mat-autocomplete>
            <mat-hint>Press Enter or comma to add a new tag.</mat-hint>
          </mat-form-field>

          <!-- Capacity -->
          <mat-form-field appearance="outline">
            <mat-label>Capacity (optional)</mat-label>
            <input matInput formControlName="capacity" type="number" placeholder="Leave empty for unlimited">
            <mat-error *ngIf="hasError('capacity', 'min')">Capacity must be at least 1.</mat-error>
          </mat-form-field>
          
          <!-- Visibility -->
          <div class="visibility-group">
            <mat-label class="visibility-label">Visibility:</mat-label>
            <mat-radio-group formControlName="visibility">
              <mat-radio-button value="Public">Public - Anyone can see and join this event</mat-radio-button>
              <mat-radio-button value="Private">Private - Only invited people can see this event</mat-radio-button>
            </mat-radio-group>
          </div>

          <!-- Form Actions -->
          <mat-card-actions class="form-actions">
            <button type="button" mat-button (click)="onCancel()">Cancel</button>
            <button mat-raised-button color="primary" type="submit" [disabled]="eventForm.invalid || vm.isSaving">
              <span *ngIf="!vm.isSaving">Create Event</span>
              <span *ngIf="vm.isSaving">Creating...</span>
            </button>
          </mat-card-actions>
        </form>
      </mat-card-content>
    </mat-card>
  </div>
</ng-container>

